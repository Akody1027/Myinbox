<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Inbox</title>
    <style>
        :root {
            --primary: #0084ff;
            --danger: #ff3b30;
            --warning: #ffcc00;
            --bg: #f0f2f5;
            --surface: #ffffff;
            --text: #050505;
            --bubble-me: #0084ff;
            --bubble-them: #e4e6eb;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            margin: 0;
            height: 100vh;
            display: flex;
            justify-content: center;
        }

        /* --- Login Modal --- */
        #auth-modal {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.95);
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .auth-box {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            text-align: center;
            width: 300px;
        }
        .auth-box input {
            width: 90%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
        }
        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
        }

        /* --- Main App Container --- */
        #app-container {
            width: 100%;
            max-width: 480px; /* Mobile View limit */
            height: 100%;
            background: var(--surface);
            display: none; /* Hidden until login */
            flex-direction: column;
            position: relative;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }

        /* --- Header --- */
        header {
            padding: 10px 15px;
            border-bottom: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
            z-index: 10;
            height: 50px;
        }
        h2 { margin: 0; font-size: 18px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* --- Inbox View --- */
        #inbox-view {
            flex: 1;
            overflow-y: auto;
            display: flex; /* Flex to show/hide */
            flex-direction: column;
        }
        .thread-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .thread-item:hover { background: #f9f9f9; }
        .thread-info { flex: 1; margin-left: 10px; }
        .thread-name { font-weight: bold; }
        .thread-preview { font-size: 12px; color: #666; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
        .badge {
            background: red;
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 5px;
            display: none; /* Hidden if 0 */
        }
        .select-mode-checkbox {
            display: none; /* Hidden unless in merge mode */
            margin-right: 10px;
            transform: scale(1.5);
        }

        /* --- Chat View --- */
        #chat-view {
            flex: 1;
            display: none; /* Hidden default */
            flex-direction: column;
            height: 100%;
        }
        
        /* Chat Header specific styles */
        .chat-header-actions {
            display: flex;
            gap: 8px;
        }
        .btn-small {
            padding: 5px 10px;
            font-size: 12px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            color: white;
        }
        .btn-block { background-color: #888; }
        .btn-delete { background-color: var(--danger); }
        .btn-unblock { background-color: var(--primary); }

        #messages-list {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            background: white;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .message {
            max-width: 70%;
            padding: 8px 12px;
            border-radius: 18px;
            font-size: 14px;
            position: relative;
            word-wrap: break-word;
        }
        .message.me {
            align-self: flex-end;
            background-color: var(--bubble-me);
            color: white;
            border-bottom-right-radius: 4px;
        }
        .message.them {
            align-self: flex-start;
            background-color: var(--bubble-them);
            color: black;
            border-bottom-left-radius: 4px;
        }
        .message img, .message video {
            max-width: 100%;
            border-radius: 12px;
            margin-bottom: 5px;
            display: block;
        }
        .sender-name {
            font-size: 10px;
            margin-bottom: 2px;
            opacity: 0.7;
            display: block;
        }
        .system-message {
            align-self: center;
            background: #eee;
            color: #555;
            font-size: 12px;
            padding: 4px 10px;
            border-radius: 10px;
        }

        /* --- Sandbox Input Area --- */
        #input-area {
            border-top: 1px solid #ddd;
            background: white;
            padding: 10px;
        }
        #sandbox-preview {
            display: none; /* Hidden until media selected */
            padding: 10px;
            background: #f0f0f0;
            border-radius: 8px;
            margin-bottom: 10px;
            position: relative;
        }
        #sandbox-preview img, #sandbox-preview video {
            max-height: 100px;
            border-radius: 4px;
        }
        #clear-media {
            position: absolute;
            top: 5px; right: 5px;
            background: red; color: white;
            border: none; border-radius: 50%;
            width: 20px; height: 20px;
            cursor: pointer;
        }
        .input-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        #message-input {
            flex: 1;
            padding: 10px;
            border-radius: 20px;
            border: 1px solid #ddd;
            outline: none;
        }
        .icon-btn {
            background: none; border: none; font-size: 20px; cursor: pointer; color: var(--primary);
        }

        /* --- Merge Controls --- */
        #merge-controls {
            padding: 10px;
            background: #e4e6eb;
            display: none; /* Hidden unless select mode */
            justify-content: space-between;
            align-items: center;
        }

        /* Helper */
        .hidden { display: none !important; }
        .blocked-notice {
            text-align: center;
            padding: 10px;
            color: red;
            background: #ffebeb;
            font-size: 14px;
            display: none;
        }
    </style>
</head>
<body>

    <div id="auth-modal">
        <div class="auth-box">
            <h2>Welcome to My Inbox</h2>
            <input type="text" id="login-name" placeholder="Enter your Name" />
            <input type="password" id="login-pin" placeholder="4-Digit PIN" maxlength="4" />
            <button class="btn" id="login-btn">Enter Inbox</button>
            <p id="login-error" style="color:red; font-size:12px; margin-top:5px;"></p>
        </div>
    </div>

    <div id="app-container">
        
        <header id="inbox-header">
            <h2>My Inbox</h2>
            <div>
                <button class="icon-btn" id="toggle-select-mode" title="Select to Merge">Select</button>
                <button class="icon-btn" id="create-chat-btn" title="New Chat" style="margin-left:10px;">+</button>
            </div>
        </header>

        <div id="merge-controls">
            <span>Select threads to merge</span>
            <button class="btn" id="confirm-merge-btn" style="width: auto; padding: 5px 15px;">Merge</button>
        </div>

        <div id="inbox-view">
            </div>

        <div id="chat-view">
            <header>
                <div style="display: flex; align-items: center;">
                    <button class="icon-btn" id="back-btn" style="margin-right: 10px;">‚Üê</button>
                    <h2 id="chat-title">Chat Name</h2>
                </div>
                <div class="chat-header-actions">
                    <button id="block-btn" class="btn-small btn-block">Block</button>
                    <button id="delete-btn" class="btn-small btn-delete">Delete</button>
                </div>
            </header>

            <div id="messages-list">
                </div>

            <div id="blocked-notice" class="blocked-notice">
                This conversation is blocked.
            </div>

            <div id="input-area">
                <div id="sandbox-preview">
                    <button id="clear-media">√ó</button>
                    <div id="media-container"></div>
                </div>

                <div class="input-row">
                    <input type="file" id="media-input" accept="image/*,video/*" style="display: none;" />
                    <button class="icon-btn" id="attach-btn">üìé</button>
                    <input type="text" id="message-input" placeholder="Type a message..." />
                    <button class="icon-btn" id="send-btn">‚û§</button>
                </div>
            </div>
        </div>

    </div>

    <audio id="notif-sound" src="https://assets.mixkit.co/active_storage/sfx/2354/2354-preview.m4a" preload="auto"></audio>

    <script type="module">
        // Import Firebase SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-app.js";
        import { getFirestore, collection, addDoc, query, where, onSnapshot, doc, getDoc, setDoc, deleteDoc, updateDoc, serverTimestamp, orderBy } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-storage.js";

        // --- CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyBsIfcS2kY29alWNQBqaLwQ9To4LwlcRD8",
            authDomain: "myinbox-f9937.firebaseapp.com",
            projectId: "myinbox-f9937",
            storageBucket: "myinbox-f9937.firebasestorage.app",
            messagingSenderId: "906002940697",
            appId: "1:906002940697:web:6bea44f2927a6a8df23b88",
            measurementId: "G-VKN6E7XTF8"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // --- STATE ---
        let currentUser = null;
        let currentChatId = null;
        let selectedFile = null;
        let isSelectMode = false;
        let unsubscribeMessages = null;
        let unsubscribeThreadMeta = null; // Listener for thread status (blocked/deleted)

        // --- DOM ELEMENTS ---
        const authModal = document.getElementById('auth-modal');
        const loginName = document.getElementById('login-name');
        const loginPin = document.getElementById('login-pin');
        const loginBtn = document.getElementById('login-btn');
        const loginError = document.getElementById('login-error');
        const appContainer = document.getElementById('app-container');
        const inboxView = document.getElementById('inbox-view');
        const chatView = document.getElementById('chat-view');
        const inboxHeader = document.getElementById('inbox-header');
        const backBtn = document.getElementById('back-btn');
        const messagesList = document.getElementById('messages-list');
        const messageInput = document.getElementById('message-input');
        const sendBtn = document.getElementById('send-btn');
        const createChatBtn = document.getElementById('create-chat-btn');
        const blockBtn = document.getElementById('block-btn');
        const deleteBtn = document.getElementById('delete-btn');
        const blockedNotice = document.getElementById('blocked-notice');
        const inputArea = document.getElementById('input-area');
        
        // Sandbox Elements
        const attachBtn = document.getElementById('attach-btn');
        const mediaInput = document.getElementById('media-input');
        const sandboxPreview = document.getElementById('sandbox-preview');
        const mediaContainer = document.getElementById('media-container');
        const clearMediaBtn = document.getElementById('clear-media');

        // Merge Elements
        const toggleSelectBtn = document.getElementById('toggle-select-mode');
        const mergeControls = document.getElementById('merge-controls');
        const confirmMergeBtn = document.getElementById('confirm-merge-btn');

        // --- AUTH LOGIC ---
        loginBtn.addEventListener('click', async () => {
            const name = loginName.value.trim();
            const pin = loginPin.value.trim();

            if (!name || pin.length !== 4) {
                loginError.textContent = "Please enter a name and a 4-digit PIN.";
                return;
            }

            const userId = name.toLowerCase().replace(/\s+/g, '-');
            const userDocRef = doc(db, "users", userId);

            try {
                const userSnap = await getDoc(userDocRef);

                if (userSnap.exists()) {
                    if (userSnap.data().pin === pin) {
                        currentUser = { id: userId, ...userSnap.data() };
                        enterApp();
                    } else {
                        loginError.textContent = "Incorrect PIN.";
                    }
                } else {
                    const newUser = { name: name, pin: pin, createdAt: serverTimestamp() };
                    await setDoc(userDocRef, newUser);
                    currentUser = { id: userId, ...newUser };
                    enterApp();
                }
            } catch (error) {
                console.error("Login Error:", error);
                loginError.textContent = "Connection error. Check console.";
            }
        });

        function enterApp() {
            authModal.style.display = 'none';
            appContainer.style.display = 'flex';
            loadInbox();
        }

        // --- INBOX LOGIC ---
        function loadInbox() {
            const threadsRef = collection(db, "threads");
            const q = query(threadsRef, where("participants", "array-contains", currentUser.name), orderBy("lastUpdated", "desc"));

            onSnapshot(q, (snapshot) => {
                inboxView.innerHTML = '';
                snapshot.forEach(docSnap => {
                    const data = docSnap.data();
                    const threadId = docSnap.id;
                    
                    const otherParticipants = data.participants.filter(p => p !== currentUser.name);
                    const chatName = otherParticipants.join(", ");
                    const unreadCount = (data.unreadCounts && data.unreadCounts[currentUser.name]) || 0;

                    if (unreadCount > 0 && currentChatId !== threadId) {
                        document.getElementById('notif-sound').play().catch(e => console.log("Audio play prevented"));
                    }

                    const div = document.createElement('div');
                    div.className = 'thread-item';
                    div.innerHTML = `
                        <input type="checkbox" class="select-mode-checkbox ${isSelectMode ? '' : 'hidden'}" data-id="${threadId}" data-participants="${otherParticipants.join(',')}">
                        <div class="thread-info" onclick="openThread('${threadId}', '${chatName}')">
                            <div class="thread-name">${chatName} <span class="badge" style="display: ${unreadCount > 0 ? 'inline-block' : 'none'}">${unreadCount}</span></div>
                            <div class="thread-preview">${data.lastMessage || 'No messages yet'}</div>
                        </div>
                    `;
                    
                    const checkbox = div.querySelector('input');
                    checkbox.addEventListener('click', (e) => e.stopPropagation());
                    if(isSelectMode) {
                        div.querySelector('.thread-info').onclick = (e) => {
                            checkbox.checked = !checkbox.checked;
                        };
                    }

                    inboxView.appendChild(div);
                });
            });
        }

        // --- MERGE LOGIC ---
        toggleSelectBtn.addEventListener('click', () => {
            isSelectMode = !isSelectMode;
            mergeControls.style.display = isSelectMode ? 'flex' : 'none';
            toggleSelectBtn.textContent = isSelectMode ? 'Cancel' : 'Select';
            
            document.querySelectorAll('.select-mode-checkbox').forEach(box => {
                box.classList.toggle('hidden', !isSelectMode);
                box.checked = false; 
            });
            loadInbox(); 
        });

        confirmMergeBtn.addEventListener('click', async () => {
            const checkboxes = document.querySelectorAll('.select-mode-checkbox:checked');
            if (checkboxes.length < 2) {
                alert("Please select at least 2 threads to merge.");
                return;
            }

            let allParticipants = new Set([currentUser.name]);
            checkboxes.forEach(box => {
                const parts = box.dataset.participants.split(',');
                parts.forEach(p => allParticipants.add(p));
            });

            const participantArray = Array.from(allParticipants);
            
            const newThreadRef = await addDoc(collection(db, "threads"), {
                participants: participantArray,
                lastMessage: "Group created via Merge",
                lastUpdated: serverTimestamp(),
                unreadCounts: {}
            });

            isSelectMode = false;
            mergeControls.style.display = 'none';
            toggleSelectBtn.textContent = 'Select';
            loadInbox();
            
            openThread(newThreadRef.id, participantArray.filter(p => p !== currentUser.name).join(", "));
        });

        // --- NEW CHAT LOGIC ---
        createChatBtn.addEventListener('click', async () => {
            const targetName = prompt("Enter the exact name of the person you want to message:");
            if (!targetName) return;
            if (targetName === currentUser.name) return alert("You can't message yourself.");

            await addDoc(collection(db, "threads"), {
                participants: [currentUser.name, targetName],
                lastMessage: "Chat started",
                lastUpdated: serverTimestamp(),
                unreadCounts: {}
            });
        });


        // --- CHAT LOGIC ---
        window.openThread = (threadId, chatName) => {
            if (isSelectMode) return; 

            currentChatId = threadId;
            document.getElementById('chat-title').textContent = chatName;
            
            inboxView.style.display = 'none';
            inboxHeader.style.display = 'none';
            chatView.style.display = 'flex';

            // Reset UI State
            blockedNotice.style.display = 'none';
            inputArea.style.display = 'block';
            blockBtn.textContent = "Block";
            blockBtn.className = "btn-small btn-block";

            // Mark Read
            const threadRef = doc(db, "threads", threadId);
            updateDoc(threadRef, {
                [`unreadCounts.${currentUser.name}`]: 0
            });

            // 1. Listen for Messages
            const msgsRef = collection(db, "threads", threadId, "messages");
            const q = query(msgsRef, orderBy("timestamp", "asc"));

            if (unsubscribeMessages) unsubscribeMessages();
            unsubscribeMessages = onSnapshot(q, (snapshot) => {
                messagesList.innerHTML = '';
                snapshot.forEach(doc => {
                    renderMessage(doc.data());
                });
                scrollToBottom();
            });

            // 2. Listen for Thread Metadata (Blocked/Deleted status)
            if (unsubscribeThreadMeta) unsubscribeThreadMeta();
            unsubscribeThreadMeta = onSnapshot(threadRef, (docSnap) => {
                if (!docSnap.exists()) {
                    // Thread deleted!
                    alert("This chat has been deleted.");
                    backToInbox();
                    return;
                }
                
                const data = docSnap.data();
                
                // Handle Blocking
                if (data.blockedBy) {
                    blockedNotice.style.display = 'block';
                    inputArea.style.display = 'none';
                    
                    if (data.blockedBy === currentUser.id) {
                        blockBtn.textContent = "Unblock";
                        blockBtn.className = "btn-small btn-unblock";
                        blockedNotice.textContent = "You have blocked this user.";
                    } else {
                        blockBtn.textContent = "Block"; // Can't block a blocker, just default
                        blockBtn.disabled = true;
                        blockedNotice.textContent = "You have been blocked.";
                    }
                } else {
                    blockedNotice.style.display = 'none';
                    inputArea.style.display = 'block';
                    blockBtn.textContent = "Block";
                    blockBtn.className = "btn-small btn-block";
                    blockBtn.disabled = false;
                }
            });
        };

        function backToInbox() {
            currentChatId = null;
            if (unsubscribeMessages) unsubscribeMessages();
            if (unsubscribeThreadMeta) unsubscribeThreadMeta();
            chatView.style.display = 'none';
            inboxView.style.display = 'flex';
            inboxHeader.style.display = 'flex';
        }

        backBtn.addEventListener('click', backToInbox);

        // --- BLOCK & DELETE BUTTONS ---
        blockBtn.addEventListener('click', async () => {
            if (!currentChatId) return;
            const threadRef = doc(db, "threads", currentChatId);
            const docSnap = await getDoc(threadRef);
            if (!docSnap.exists()) return;

            const isCurrentlyBlocked = docSnap.data().blockedBy === currentUser.id;

            if (isCurrentlyBlocked) {
                // UNBLOCK ACTION
                if(confirm("Unblock this user?")) {
                    await updateDoc(threadRef, { blockedBy: null });
                }
            } else {
                // BLOCK ACTION
                if(confirm("Are you sure you want to block this user? You will not receive messages from them.")) {
                    await updateDoc(threadRef, { blockedBy: currentUser.id });
                }
            }
        });

        deleteBtn.addEventListener('click', async () => {
            if (!currentChatId) return;
            if (confirm("Are you sure? This will permanently delete this conversation for everyone.")) {
                const threadRef = doc(db, "threads", currentChatId);
                await deleteDoc(threadRef);
                // The onSnapshot listener will handle the UI redirect
            }
        });

        function renderMessage(msg) {
            const div = document.createElement('div');
            const isMe = msg.sender === currentUser.name;
            div.className = `message ${isMe ? 'me' : 'them'}`;
            
            let content = '';
            
            if (msg.sender !== currentUser.name && !isMe) {
                 content += `<span class="sender-name">${msg.sender}</span>`;
            }

            if (msg.mediaUrl) {
                if (msg.mediaType && msg.mediaType.startsWith('video')) {
                    content += `<video src="${msg.mediaUrl}" controls></video>`;
                } else {
                    content += `<img src="${msg.mediaUrl}" alt="image" />`;
                }
            }
            if (msg.text) {
                content += `<div>${msg.text}</div>`;
            }

            div.innerHTML = content;
            messagesList.appendChild(div);
        }

        function scrollToBottom() {
            messagesList.scrollTop = messagesList.scrollHeight;
        }

        // --- SANDBOX & SENDING ---
        attachBtn.addEventListener('click', () => mediaInput.click());

        mediaInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            selectedFile = file;
            sandboxPreview.style.display = 'block';
            mediaContainer.innerHTML = '';
            const url = URL.createObjectURL(file);
            if (file.type.startsWith('video')) {
                const vid = document.createElement('video');
                vid.src = url;
                vid.controls = true;
                mediaContainer.appendChild(vid);
            } else {
                const img = document.createElement('img');
                img.src = url;
                mediaContainer.appendChild(img);
            }
        });

        clearMediaBtn.addEventListener('click', () => {
            selectedFile = null;
            mediaInput.value = '';
            sandboxPreview.style.display = 'none';
            mediaContainer.innerHTML = '';
        });

        sendBtn.addEventListener('click', async () => {
            const text = messageInput.value.trim();
            if (!text && !selectedFile) return;

            messageInput.value = '';
            const fileToSend = selectedFile;
            clearMediaBtn.click(); 

            let mediaUrl = null;
            let mediaType = null;

            if (fileToSend) {
                mediaType = fileToSend.type;
                const storageRef = ref(storage, `chat-media/${Date.now()}_${fileToSend.name}`);
                const snapshot = await uploadBytes(storageRef, fileToSend);
                mediaUrl = await getDownloadURL(snapshot.ref);
            }

            const threadRef = doc(db, "threads", currentChatId);
            const messagesRef = collection(threadRef, "messages");

            await addDoc(messagesRef, {
                text: text,
                sender: currentUser.name,
                mediaUrl: mediaUrl,
                mediaType: mediaType,
                timestamp: serverTimestamp()
            });

            // Update thread metadata
            const threadSnap = await getDoc(threadRef);
            if (!threadSnap.exists()) return; // Edge case: thread deleted while typing

            const participants = threadSnap.data().participants;
            let unreadUpdates = {};
            const currentCounts = threadSnap.data().unreadCounts || {};
            
            participants.forEach(p => {
                if (p !== currentUser.name) {
                    unreadUpdates[`unreadCounts.${p}`] = (currentCounts[p] || 0) + 1;
                }
            });

            await updateDoc(threadRef, {
                lastMessage: text || (mediaType ? "Sent an attachment" : "New Message"),
                lastUpdated: serverTimestamp(),
                ...unreadUpdates
            });
        });

    </script>
</body>
</html>
